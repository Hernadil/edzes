{% extends 'main.html' %} {% block content %}

<main class="page-wrap">
  <section class="home-panel">
    <div
      class="workout-session"
      style="max-width: 900px; margin: 0 auto; padding: 20px"
    >
      <!-- Időmérő -->
      <div
        class="card big"
        style="text-align: center; margin-bottom: 24px; padding: 32px"
      >
        <h2 style="margin: 0 0 16px 0; color: var(--white)">Edzésidő</h2>
        <div
          style="
            font-size: 3rem;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 16px;
          "
          id="timer"
        >
          00:00
        </div>
        <input type="hidden" id="elapsed-minutes" value="0" />
      </div>

      <!-- Gyakorlatok táblázat -->
      <form method="post" action="{% url 'start' workout_id=workout_id %}" id="workoutForm">
        {% csrf_token %}
        <input type="hidden" name="elapsed_time" id="elapsed-time-input" />

        <div class="card big" style="padding: 32px">
          <h2 style="margin: 0 0 24px 0; color: var(--white)">Gyakorlatok</h2>

          <div class="exercises-table" style="width: 100%; overflow-x: auto">
            <table style="width: 100%; border-collapse: collapse">
              <thead>
                <tr style="border-bottom: 2px solid rgba(255, 255, 255, 0.1)">
                  <th
                    style="
                      padding: 16px;
                      text-align: left;
                      color: var(--muted);
                      font-weight: 700;
                      font-size: 0.9rem;
                    "
                  >
                    Gyakorlat
                  </th>
                  <th
                    style="
                      padding: 16px;
                      text-align: center;
                      color: var(--muted);
                      font-weight: 700;
                      font-size: 0.9rem;
                    "
                  >
                    Ismétlések
                  </th>
                  <th
                    style="
                      padding: 16px;
                      text-align: center;
                      color: var(--muted);
                      font-weight: 700;
                      font-size: 0.9rem;
                    "
                  >
                    Jelenlegi súly (kg)
                  </th>
                  <th
                    style="
                      padding: 16px;
                      text-align: center;
                      color: var(--muted);
                      font-weight: 700;
                      font-size: 0.9rem;
                    "
                  >
                    Új súly (kg)
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for excercise in excercises %} {% for weight in weights %}
                {% if weight.excerciseid.id == excercise.id %}
                <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05)">
                  <td
                    data-label=""
                    style="
                      padding: 20px;
                      color: var(--white);
                      font-weight: 600;
                      font-size: 1.1rem;
                    "
                  >
                    {{ excercise.name }}
                  </td>
                  <td
                    data-label="Ismétlések"
                    style="
                      padding: 20px;
                      text-align: center;
                      color: var(--white);
                      font-size: 1rem;
                    "
                  >
                    {{ excercise.reps }}
                  </td>
                  <td
                    data-label="Jelenlegi súly"
                    style="
                      padding: 20px;
                      text-align: center;
                      color: var(--accent);
                      font-weight: 700;
                      font-size: 1.1rem;
                    "
                  >
                    {{ weight.weight }}
                  </td>
                  <td
                    data-label="Új súly (kg)"
                    style="padding: 20px; text-align: center"
                  >
                    <input
                      type="number"
                      name="new_weight_{{ excercise.id }}"
                      value="{{ weight.weight }}"
                      min="0"
                      step="0.5"
                      style="
                        width: 80px;
                        padding: 8px 12px;
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 8px;
                        color: var(--white);
                        text-align: center;
                        font-size: 1rem;
                        font-weight: 600;
                      "
                    />
                  </td>
                </tr>
                {% endif %} {% endfor %} {% endfor %}
              </tbody>
            </table>
          </div>

          <div style="margin-top: 24px; display: flex; flex-direction: column; gap: 8px;">
            <label for="notes" style="color: var(--muted); font-weight: 700;">Megjegyzés</label>
            <input
              id="notes"
              name="notes"
              type="text"
              placeholder="{{ comment }}"
              style="
                width: 100%;
                padding: 10px 14px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                color: var(--white);
                font-size: 1rem;
              "
            />
          </div>

          <button
            type="button"
            onclick="showFinishModal()"
            class="btn form-btn"
            style="margin-top: 32px; width: 100%"
          >
            Edzés befejezése
          </button>
        </div>
        <div style="text-align: center; margin-top: 24px;">
          <button
            type="button"
            name="action"
            value="back_home"
            onclick="showBackHomeModal()"
            class="btn form-btn"
            style="width: 100%; max-width: 300px; margin: 0 auto;"
          >
            Vissza a főoldalra
          </button>
        </div>    
        
      </form>
      

      
    </div>
  </section>
</main>

<!-- Finish Workout Modal -->
<div id="finishModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: var(--bg-secondary); border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
    <h3 style="color: var(--white); margin: 0 0 16px 0; font-size: 1.5rem; text-align: center;">Edzés befejezése</h3>
    <p style="color: var(--muted); margin: 0 0 24px 0; text-align: center; line-height: 1.5;">Biztosan be szeretnéd fejezni az edzést?</p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button onclick="closeFinishModal()" style="background: var(--bg-primary); color: var(--white); border: 2px solid var(--muted); border-radius: 8px; padding: 12px 24px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='var(--bg-primary)'">
        Mégse
      </button>
      <button onclick="confirmFinish()" style="background: var(--accent); color: white; border: none; border-radius: 8px; padding: 12px 24px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
        Befejezés
      </button>
    </div>
  </div>
</div>

<!-- Back Home Modal -->
<div id="backHomeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: var(--bg-secondary); border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
    <h3 style="color: var(--white); margin: 0 0 16px 0; font-size: 1.5rem; text-align: center;">Vissza a főoldalra</h3>
    <p style="color: var(--muted); margin: 0 0 24px 0; text-align: center; line-height: 1.5;">Biztosan vissza szeretnél menni a főoldalra? Az edzés folytatódni fog.</p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button onclick="closeBackHomeModal()" style="background: var(--bg-primary); color: var(--white); border: 2px solid var(--muted); border-radius: 8px; padding: 12px 24px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='var(--bg-primary)'">
        Mégse
      </button>
      <button onclick="confirmBackHome()" style="background: var(--accent); color: white; border: none; border-radius: 8px; padding: 12px 24px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
        Vissza
      </button>
    </div>
  </div>
</div>

<script>
  // Django változóból mentett idő (percben) - biztonságos parseInt
  let savedMinutes = parseInt("{{ timer|default:'0' }}") || 0;
  
  // Számold vissza a startTime-ot, hogy onnan induljon
  let startTime = Date.now() - (savedMinutes * 60 * 1000);
  let timerInterval;

  function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;

    document.getElementById("timer").textContent = `${String(minutes).padStart(
      2,
      "0"
    )}:${String(seconds).padStart(2, "0")}`;

    document.getElementById("elapsed-minutes").value = minutes;
    document.getElementById("elapsed-time-input").value = minutes;
  }

  timerInterval = setInterval(updateTimer, 1000);
  updateTimer();

  // Finish Modal Functions
  function showFinishModal() {
    document.getElementById('finishModal').style.display = 'flex';
  }

  function closeFinishModal() {
    document.getElementById('finishModal').style.display = 'none';
  }

  function confirmFinish() {
    document.getElementById('workoutForm').submit();
  }

  // Back Home Modal Functions
  function showBackHomeModal() {
    document.getElementById('backHomeModal').style.display = 'flex';
  }

  function closeBackHomeModal() {
    document.getElementById('backHomeModal').style.display = 'none';
  }

  function confirmBackHome() {
    const form = document.getElementById('workoutForm');
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'action';
    input.value = 'back_home';
    form.appendChild(input);
    form.submit();
  }

  // Modal háttér kattintás
  document.getElementById('finishModal').addEventListener('click', function(e) {
    if (e.target === this) closeFinishModal();
  });

  document.getElementById('backHomeModal').addEventListener('click', function(e) {
    if (e.target === this) closeBackHomeModal();
  });
</script>

{% endblock %}